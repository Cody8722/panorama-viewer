<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全景圖瀏覽器 - Panorama Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Pannellum CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        #panorama {
            width: 100%;
            height: 70vh;
            border-radius: 0.5rem;
        }

        .panorama-item:hover {
            background-color: #f3f4f6;
            cursor: pointer;
        }

        .panorama-item.active {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        .loading {
            display: none;
        }

        .loading.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 後端 URL 設定 -->
    <script>
        // 修改為您的後端 URL
        // 本地開發
        window.BACKEND_URL = 'http://localhost:5002';

        // 生產環境（部署後修改）
        // window.BACKEND_URL = 'https://your-backend.zeabur.app';
    </script>

    <div class="container mx-auto px-4 py-8">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-globe text-blue-500"></i> 全景圖瀏覽器
            </h1>
            <p class="text-gray-600">上傳、瀏覽和管理您的 360° 全景圖片</p>
        </div>

        <!-- 上傳區域 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-cloud-upload-alt text-blue-500"></i> 上傳全景圖
            </h2>

            <form id="uploadForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        選擇全景圖片 <span class="text-red-500">*</span>
                    </label>
                    <input type="file" id="fileInput" accept="image/*" required
                           class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-full file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-blue-50 file:text-blue-700
                                  hover:file:bg-blue-100"/>
                    <p class="mt-1 text-sm text-gray-500">支援格式: JPG, PNG, WEBP（最大 50MB）</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        標題 <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="titleInput" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: 美麗的海邊風景">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        描述（選填）
                    </label>
                    <textarea id="descriptionInput" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="為這張全景圖添加一些描述..."></textarea>
                </div>

                <button type="submit" id="uploadBtn"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-upload mr-2"></i>
                    <span>上傳全景圖</span>
                </button>

                <div id="uploadProgress" class="loading">
                    <div class="flex items-center justify-center text-blue-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        <span>上傳中，請稍候...</span>
                    </div>
                </div>
            </form>
        </div>

        <!-- 全景圖查看器與列表 -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- 全景圖列表 -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-images text-blue-500"></i> 全景圖列表
                    </h2>

                    <div id="panoramaList" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-image text-4xl mb-2"></i>
                            <p>尚無全景圖</p>
                            <p class="text-sm">請先上傳圖片</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 全景圖查看器 -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-semibold text-gray-800" id="currentTitle">
                                全景圖查看器
                            </h2>
                            <p class="text-gray-600 text-sm" id="currentDescription"></p>
                        </div>

                        <div class="flex space-x-2" id="viewerControls" style="display: none;">
                            <button onclick="sharePanorama()"
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-share-alt"></i> 分享
                            </button>
                            <button onclick="editPanorama()"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            <button onclick="deletePanorama()"
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        </div>
                    </div>

                    <div id="panoramaContainer">
                        <div id="panorama" class="bg-gray-100 flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-globe text-6xl mb-4"></i>
                                <p class="text-xl">請選擇或上傳全景圖</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯對話框 -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">編輯全景圖資訊</h3>

            <form id="editForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">標題</label>
                    <input type="text" id="editTitle" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                    <textarea id="editDescription" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">
                        儲存
                    </button>
                    <button type="button" onclick="closeEditModal()"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 分享對話框 -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-lg w-full mx-4">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-share-alt text-green-500 mr-2"></i>分享全景圖
            </h3>

            <p class="text-gray-600 mb-4">
                使用下方的唯讀連結分享這張全景圖。收到連結的人只能查看，無法編輯或刪除。
            </p>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">分享連結</label>
                <div class="flex space-x-2">
                    <input type="text" id="shareLink" readonly
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-mono"
                           value="">
                    <button onclick="copyShareLink()"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition whitespace-nowrap">
                        <i class="fas fa-copy mr-2"></i>複製
                    </button>
                </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h4 class="font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>分享特點
                </h4>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li><i class="fas fa-check mr-2"></i>獨立的查看頁面</li>
                    <li><i class="fas fa-check mr-2"></i>只能觀看，無法編輯</li>
                    <li><i class="fas fa-check mr-2"></i>全螢幕瀏覽支援</li>
                    <li><i class="fas fa-check mr-2"></i>無需登入即可查看</li>
                </ul>
            </div>

            <div class="flex space-x-4">
                <button onclick="openShareLink()"
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg">
                    <i class="fas fa-external-link-alt mr-2"></i>開啟預覽
                </button>
                <button onclick="closeShareModal()"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                    <i class="fas fa-times mr-2"></i>關閉
                </button>
            </div>
        </div>
    </div>

    <script>
        let panoramas = [];
        let currentPanoramaId = null;
        let viewer = null;

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            loadPanoramas();

            // 上傳表單處理
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);

            // 編輯表單處理
            document.getElementById('editForm').addEventListener('submit', handleEdit);

            // 檔案選擇時自動填入標題
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && !document.getElementById('titleInput').value) {
                    const fileName = file.name.replace(/\.[^/.]+$/, ""); // 移除副檔名
                    document.getElementById('titleInput').value = fileName;
                }
            });
        });

        // 載入全景圖列表
        async function loadPanoramas() {
            try {
                const response = await fetch(`${window.BACKEND_URL}/api/panoramas`);

                if (!response.ok) {
                    throw new Error('載入失敗');
                }

                panoramas = await response.json();
                renderPanoramaList();

                // 如果有全景圖，自動顯示第一張
                if (panoramas.length > 0) {
                    loadPanoramaViewer(panoramas[0]._id);
                }
            } catch (error) {
                console.error('載入全景圖列表失敗:', error);
                showNotification('載入全景圖列表失敗', 'error');
            }
        }

        // 渲染全景圖列表
        function renderPanoramaList() {
            const container = document.getElementById('panoramaList');

            if (panoramas.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-image text-4xl mb-2"></i>
                        <p>尚無全景圖</p>
                        <p class="text-sm">請先上傳圖片</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = panoramas.map(p => `
                <div class="panorama-item p-3 rounded-lg border border-gray-200 ${p._id === currentPanoramaId ? 'active' : ''}"
                     onclick="loadPanoramaViewer('${p._id}')">
                    <div class="font-medium text-gray-800">${escapeHtml(p.title)}</div>
                    <div class="text-sm text-gray-500">
                        <i class="far fa-calendar"></i> ${formatDate(p.created_at)}
                    </div>
                    <div class="text-xs text-gray-400">
                        <i class="fas fa-hdd"></i> ${formatFileSize(p.file_size)}
                    </div>
                </div>
            `).join('');
        }

        // 載入全景圖到查看器
        async function loadPanoramaViewer(panoramaId) {
            try {
                const panorama = panoramas.find(p => p._id === panoramaId);

                if (!panorama) {
                    throw new Error('找不到全景圖');
                }

                currentPanoramaId = panoramaId;

                // 更新標題和描述
                document.getElementById('currentTitle').textContent = panorama.title;
                document.getElementById('currentDescription').textContent = panorama.description || '';
                document.getElementById('viewerControls').style.display = 'flex';

                // 銷毀舊的查看器
                if (viewer) {
                    viewer.destroy();
                }

                // 建立新的 Pannellum 查看器
                viewer = pannellum.viewer('panorama', {
                    type: 'equirectangular',
                    panorama: `${window.BACKEND_URL}/api/panoramas/${panoramaId}/image`,
                    autoLoad: true,
                    showControls: true,
                    showFullscreenCtrl: true,
                    showZoomCtrl: true,
                    mouseZoom: true,
                    doubleClickZoom: true,
                    draggable: true,
                    keyboardZoom: true,
                    disableKeyboardCtrl: false,
                    compass: true,
                    northOffset: 0,
                    hfov: 100,
                    minHfov: 50,
                    maxHfov: 120,
                    pitch: 0,
                    yaw: 0
                });

                // 更新列表選中狀態
                renderPanoramaList();

            } catch (error) {
                console.error('載入全景圖失敗:', error);
                showNotification('載入全景圖失敗', 'error');
            }
        }

        // 處理上傳
        async function handleUpload(e) {
            e.preventDefault();

            const fileInput = document.getElementById('fileInput');
            const titleInput = document.getElementById('titleInput');
            const descriptionInput = document.getElementById('descriptionInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadProgress = document.getElementById('uploadProgress');

            const file = fileInput.files[0];

            if (!file) {
                showNotification('請選擇檔案', 'error');
                return;
            }

            // 顯示進度
            uploadBtn.disabled = true;
            uploadProgress.classList.add('active');

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('title', titleInput.value);
                formData.append('description', descriptionInput.value);

                const response = await fetch(`${window.BACKEND_URL}/api/panoramas`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '上傳失敗');
                }

                const result = await response.json();

                showNotification('上傳成功！', 'success');

                // 清空表單
                fileInput.value = '';
                titleInput.value = '';
                descriptionInput.value = '';

                // 重新載入列表
                await loadPanoramas();

            } catch (error) {
                console.error('上傳失敗:', error);
                showNotification(error.message || '上傳失敗', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadProgress.classList.remove('active');
            }
        }

        // 編輯全景圖
        function editPanorama() {
            if (!currentPanoramaId) return;

            const panorama = panoramas.find(p => p._id === currentPanoramaId);
            if (!panorama) return;

            document.getElementById('editTitle').value = panorama.title;
            document.getElementById('editDescription').value = panorama.description || '';
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        // 關閉編輯對話框
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // 處理編輯
        async function handleEdit(e) {
            e.preventDefault();

            if (!currentPanoramaId) return;

            try {
                const response = await fetch(`${window.BACKEND_URL}/api/panoramas/${currentPanoramaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: document.getElementById('editTitle').value,
                        description: document.getElementById('editDescription').value
                    })
                });

                if (!response.ok) {
                    throw new Error('更新失敗');
                }

                showNotification('更新成功！', 'success');
                closeEditModal();
                await loadPanoramas();
                loadPanoramaViewer(currentPanoramaId);

            } catch (error) {
                console.error('更新失敗:', error);
                showNotification('更新失敗', 'error');
            }
        }

        // 刪除全景圖
        async function deletePanorama() {
            if (!currentPanoramaId) return;

            if (!confirm('確定要刪除這張全景圖嗎？此操作無法復原。')) {
                return;
            }

            try {
                const response = await fetch(`${window.BACKEND_URL}/api/panoramas/${currentPanoramaId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('刪除失敗');
                }

                showNotification('刪除成功！', 'success');

                // 銷毀查看器
                if (viewer) {
                    viewer.destroy();
                    viewer = null;
                }

                currentPanoramaId = null;
                document.getElementById('currentTitle').textContent = '全景圖查看器';
                document.getElementById('currentDescription').textContent = '';
                document.getElementById('viewerControls').style.display = 'none';

                // 重新載入列表
                await loadPanoramas();

            } catch (error) {
                console.error('刪除失敗:', error);
                showNotification('刪除失敗', 'error');
            }
        }

        // 工具函式
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 分享全景圖
        function sharePanorama() {
            if (!currentPanoramaId) return;

            // 生成分享連結
            const currentUrl = window.location.origin + window.location.pathname;
            const viewerUrl = currentUrl.replace('index.html', 'viewer.html');
            const shareUrl = `${viewerUrl}?id=${currentPanoramaId}`;

            // 顯示在對話框中
            document.getElementById('shareLink').value = shareUrl;
            document.getElementById('shareModal').classList.remove('hidden');
            document.getElementById('shareModal').classList.add('flex');
        }

        // 關閉分享對話框
        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
            document.getElementById('shareModal').classList.remove('flex');
        }

        // 複製分享連結
        function copyShareLink() {
            const shareLinkInput = document.getElementById('shareLink');
            shareLinkInput.select();
            shareLinkInput.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                showNotification('連結已複製到剪貼簿！', 'success');
            } catch (err) {
                // 使用新的 Clipboard API
                navigator.clipboard.writeText(shareLinkInput.value).then(() => {
                    showNotification('連結已複製到剪貼簿！', 'success');
                }).catch(() => {
                    showNotification('複製失敗，請手動複製', 'error');
                });
            }
        }

        // 開啟分享連結（新分頁）
        function openShareLink() {
            const shareUrl = document.getElementById('shareLink').value;
            window.open(shareUrl, '_blank');
        }
    </script>
</body>
</html>
